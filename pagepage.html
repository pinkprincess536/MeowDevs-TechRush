


<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Submit Request</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f3f4f6;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      margin: 0;
      padding: 20px;
      box-sizing: border-box;
    }

    .form-container {
      background: #fff;
      padding: 2rem;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      width: 100%;
      max-width: 400px;
    }

    h2 {
      margin-bottom: 1rem;
      text-align: center;
      color: #333;
    }

    label {
      display: block;
      margin: 1rem 0 0.5rem;
      font-weight: 500;
      color: #555;
    }

    input, select, button {
      width: 100%;
      padding: 0.75rem;
      border-radius: 6px;
      border: 1px solid #ccc;
      margin-bottom: 1rem;
      box-sizing: border-box;
      font-size: 14px;
    }

    input:focus, select:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
    }

    button {
      background-color: #3b82f6;
      color: white;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      border: none;
    }

    button:hover:not(:disabled) {
      background-color: #2563eb;
      transform: translateY(-1px);
    }

    button:disabled {
      background-color: #9ca3af;
      cursor: not-allowed;
      transform: none;
    }

    .error-message {
      color: #ef4444;
      font-size: 12px;
      margin-top: -0.5rem;
      margin-bottom: 1rem;
      display: none;
    }

    .success-message {
      color: #10b981;
      font-size: 14px;
      text-align: center;
      margin-bottom: 1rem;
      display: none;
    }
  </style>
</head>
<body>
  <div class="form-container">
    <h2>Submit Request</h2>
    <div id="success-message" class="success-message"></div>
    <form id="requestForm">
      <label for="username">Username:</label>
      <input type="text" id="username" name="username" required />
      <div id="username-error" class="error-message">Username is required</div>

      <label for="category">Category:</label>
      <select id="category" name="category" required>
        <option value="">-- Select Category --</option>
        <option value="Clothes">Clothes</option>
        <option value="Food">Food</option>
        <option value="Books">Books</option>
        <option value="Toys">Toys</option>
        <option value="Other">Other</option>
      </select>
      <div id="category-error" class="error-message">Please select a category</div>

      <label for="image">Image:</label>
      <input type="file" id="image" name="image" accept="image/*" required />
      <div id="image-error" class="error-message">Please choose an image</div>

      <button type="submit" id="submit-btn">Submit Request</button>
    </form>
  </div>

  <script type="module">
   
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    const SUPABASE_URL = 'https://owffebbhgkktxfcxcfdq.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im93ZmZlYmJoZ2trdHhmY3hjZmRxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM3MjgwMTcsImV4cCI6MjA2OTMwNDAxN30.7Q20V6cP_iFM7ojsD1xoKWqgj1VUe1syITi9gjxQpbw';
    
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

   
    function showError(elementId, message) {
      const errorElement = document.getElementById(elementId);
      errorElement.textContent = message;
      errorElement.style.display = 'block';
    }

    function hideError(elementId) {
      const errorElement = document.getElementById(elementId);
      errorElement.style.display = 'none';
    }

    function showSuccess(message) {
      const successElement = document.getElementById('success-message');
      successElement.textContent = message;
      successElement.style.display = 'block';
      setTimeout(() => {
        successElement.style.display = 'none';
      }, 5000);
    }

    function validateForm(username, category, imageFile) {
      let isValid = true;

     
      hideError('username-error');
      hideError('category-error');
      hideError('image-error');

  
      if (!username || username.trim() === '') {
        showError('username-error', 'Username is required');
        isValid = false;
      }

     
      if (!category) {
        showError('category-error', 'Please select a category');
        isValid = false;
      }

      if (!imageFile) {
        showError('image-error', 'Please choose an image');
        isValid = false;
      } else {
        
        const maxSize = 5 * 1024 * 1024; 
        if (imageFile.size > maxSize) {
          showError('image-error', 'Image must be smaller than 5MB');
          isValid = false;
        }

        const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp'];
        if (!allowedTypes.includes(imageFile.type)) {
          showError('image-error', 'Please upload a valid image file (JPEG, PNG, GIF, WebP)');
          isValid = false;
        }
      }

      return isValid;
    }

   
    document.addEventListener('DOMContentLoaded', () => {
      const form = document.getElementById('requestForm');
      const submitBtn = document.getElementById('submit-btn');

      form.addEventListener('submit', async (e) => {
        e.preventDefault();

        
        const username = document.getElementById('username').value.trim();
        const category = document.getElementById('category').value;
        const imageFile = document.getElementById('image').files[0];

       
        if (!validateForm(username, category, imageFile)) {
          return;
        }

        const originalButtonText = submitBtn.textContent;
        submitBtn.textContent = 'Uploading...';
        submitBtn.disabled = true;

        try {
          console.log('Starting upload process...');
          console.log('Form data:', { username, category, fileName: imageFile.name });

          const fileExt = imageFile.name.split('.').pop().toLowerCase();
          const timestamp = Date.now();
          const filePath = `uploads/${username}_${timestamp}.${fileExt}`;

          console.log('Uploading to path:', filePath);

         
          const { data: uploadData, error: uploadError } = await supabase.storage
            .from('item-images')
            .upload(filePath, imageFile, {
              cacheControl: '3600',
              upsert: false
            });

          if (uploadError) {
            console.error('Upload error:', uploadError);
            throw new Error(`Image upload failed: ${uploadError.message}`);
          }

          console.log('Upload successful:', uploadData);

         
          const { data: publicUrlData } = supabase.storage
            .from('item-images')
            .getPublicUrl(filePath);

          const imageUrl = publicUrlData.publicUrl;
          console.log('Public URL:', imageUrl);

       
          const insertData = {
            username: username,
            category: category,
            image_url: imageUrl
          };

          console.log('Inserting data:', insertData);

         
          const { data: insertResult, error: insertError } = await supabase
            .from('requests')
            .insert([insertData])
            .select(); 

          if (insertError) {
            console.error('Database insert error:', insertError);
            
            await supabase.storage
              .from('item-images')
              .remove([filePath]);
            
            throw new Error(`Failed to save request: ${insertError.message}`);
          }

          console.log('Database insert successful:', insertResult);

          showSuccess('Request submitted successfully!');

          form.reset();

        } catch (error) {
          console.error('Error during submission:', error);
          alert(`Error: ${error.message}`);
        } finally {
        
          submitBtn.textContent = originalButtonText;
          submitBtn.disabled = false;
        }
      });

      document.getElementById('username').addEventListener('input', () => {
        hideError('username-error');
      });

      document.getElementById('category').addEventListener('change', () => {
        hideError('category-error');
      });

      document.getElementById('image').addEventListener('change', () => {
        hideError('image-error');
      });
    });
  </script>
</body>
</html>